<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Re.Conecta · Clientes</title>
  <style>
    :root{
      --bg:#0b1117;--card:#0f1722;--muted:#9fb3c8;--text:#e6edf3;
      --primary:#22d3ee;--ok:#10b981;--err:#ef4444;--border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:860px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px}
    h1{margin:0 0 18px;font-size:28px;color:var(--primary)}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);margin-right:8px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    input{flex:1;min-width:220px;background:#0b1220;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:12px}
    button{background:var(--primary);border:0;border-radius:10px;color:#05202a;padding:12px 16px;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-top:1px solid var(--border);padding:12px 8px;text-align:left;color:var(--text)}
    .muted{color:var(--muted)}
    .status{margin:8px 0 0}
    .ok{color:var(--ok);font-weight:700}
    .err{color:var(--err);font-weight:700}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);margin-left:8px}
    .pill.ok{background:rgba(16,185,129,.15);color:var(--ok);border-color:rgba(16,185,129,.45)}
    .pill.err{background:rgba(239,68,68,.15);color:var(--err);border-color:rgba(239,68,68,.45)}
    small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <span class="badge">Re.Conecta · Clientes</span>
        <span class="badge">Java 17</span>
        <a class="badge" href="/swagger-ui/index.html" style="text-decoration:none;color:var(--muted)">Swagger</a>
        <span id="apiPill" class="pill err">API: não encontrado</span>
      </div>

      <h1>Gerenciamento de Clientes</h1>

      <div class="row">
        <input id="nome" placeholder="Nome" autocomplete="off" />
        <input id="email" placeholder="Email" autocomplete="off" />
        <button id="btnCriar">Cadastrar</button>
      </div>

      <div id="msg" class="status muted"></div>

      <table>
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Email</th></tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="3" class="muted">Carregando…</td></tr>
        </tbody>
      </table>
      <small class="muted">Dica: endpoints — <code>/healthz</code> • <code>/api/v1/clientes</code></small>
    </div>
  </div>

  <script>
    // Mesma origem (Render serve API e estática juntos)
    const API_BASE = ''; // vazio = mesma origem
    const HEALTH = '/healthz';
    const CLIENTES = '/api/v1/clientes';

    const $pill = document.getElementById('apiPill');
    const $msg  = document.getElementById('msg');
    const $tbody= document.getElementById('tbody');
    const $btn  = document.getElementById('btnCriar');
    const $nome = document.getElementById('nome');
    const $email= document.getElementById('email');

    function setPill(ok){
      if(ok){ $pill.textContent='API: online'; $pill.className='pill ok'; }
      else  { $pill.textContent='API: não encontrado'; $pill.className='pill err'; }
    }
    function setMsg(text,ok){
      if(!text){ $msg.textContent=''; return; }
      $msg.className = 'status ' + (ok ? 'ok' : 'err');
      $msg.textContent = text;
    }
    function rowHtml(c){ return `<tr><td>${c.id}</td><td>${c.nome}</td><td>${c.email}</td></tr>`; }

    async function ping(){
      try{
        const r = await fetch(API_BASE + HEALTH, {cache:'no-store'});
        setPill(r.ok);
        return r.ok;
      }catch(e){
        setPill(false); return false;
      }
    }

    async function listar(){
      try{
        const r = await fetch(API_BASE + CLIENTES, {cache:'no-store'});
        if(!r.ok){
          const t = await r.text();
          throw new Error(`Falha ao listar (${r.status}): ${t}`);
        }
        const data = await r.json();
        if(!Array.isArray(data) || data.length===0){
          $tbody.innerHTML = `<tr><td colspan="3" class="muted">Sem registros.</td></tr>`;
        }else{
          $tbody.innerHTML = data.map(rowHtml).join('');
        }
        setMsg('', true);
      }catch(e){
        $tbody.innerHTML = `<tr><td colspan="3" class="muted">Erro ao carregar clientes.</td></tr>`;
        setMsg(e.message, false);
      }
    }

    async function criar(){
      const nome = ($nome.value||'').trim();
      const email= ($email.value||'').trim();
      if(!nome || !email){ setMsg('Preencha nome e email.', false); return; }
      $btn.disabled = true;
      try{
        const r = await fetch(API_BASE + CLIENTES, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nome, email })
        });
        if(!r.ok){
          const t = await r.text();
          throw new Error(`Falha ao cadastrar (${r.status}): ${t}`);
        }
        $nome.value=''; $email.value='';
        setMsg('Cliente cadastrado com sucesso!', true);
        await listar();
      }catch(e){
        setMsg(e.message, false);
      }finally{
        $btn.disabled = false;
      }
    }

    document.getElementById('btnCriar').addEventListener('click', criar);

    (async function start(){
      const ok = await ping();
      if(ok) await listar();
      else{
        setMsg('API não detectada. Verifique se o serviço está ativo.', false);
        $tbody.innerHTML = `<tr><td colspan="3" class="muted">API não detectada.</td></tr>`;
      }
      // Re-ping a cada 20s para atualizar o selo
      setInterval(ping, 20000);
    })();
  </script>
</body>
</html>
